{
  "workflow_name": "Mangrove Biomass Estimation",
  "workflow_version": "1.0.0",
  "data_flow": {
    "step_1_stac_search": {
      "description": "Search AWS STAC catalog for Sentinel-2 L2A imagery",
      "function": "search_sentinel2",
      "input_parameters": {
        "bbox": {
          "type": "array",
          "format": "[west, south, east, north]",
          "example": [95.15, 15.9, 95.35, 16.1],
          "units": "decimal degrees (WGS84)",
          "description": "Bounding box for Myanmar study area"
        },
        "cloud_cover_max": {
          "type": "integer",
          "example": 20,
          "units": "percent",
          "description": "Maximum acceptable cloud cover"
        },
        "days_back": {
          "type": "integer",
          "example": 90,
          "units": "days",
          "description": "Search window from today backwards"
        }
      },
      "api_call": {
        "library": "pystac_client",
        "endpoint": "https://earth-search.aws.element84.com/v1",
        "method": "catalog.search",
        "parameters": {
          "collections": ["sentinel-2-l2a"],
          "bbox": [95.15, 15.9, 95.35, 16.1],
          "datetime": "2024-07-24T00:00:00Z/2024-10-22T00:00:00Z",
          "query": {
            "eo:cloud_cover": {
              "lt": 20
            }
          }
        }
      },
      "response_structure": {
        "type": "ItemCollection",
        "features": [
          {
            "type": "Feature",
            "id": "S2B_46QDM_20241015_0_L2A",
            "stac_version": "1.0.0",
            "collection": "sentinel-2-l2a",
            "geometry": {
              "type": "Polygon",
              "coordinates": "[[[...coordinates...]]]"
            },
            "bbox": [94.7, 15.5, 96.0, 16.5],
            "properties": {
              "datetime": "2024-10-15T04:12:31.024000Z",
              "platform": "sentinel-2b",
              "constellation": "sentinel-2",
              "instruments": ["msi"],
              "eo:cloud_cover": 12.5,
              "proj:epsg": 32646,
              "sentinel:product_id": "S2B_MSIL2A_20241015T041231_N0511_R133_T46QDM_20241015T064823",
              "sentinel:data_coverage": 100.0
            },
            "assets": {
              "red": {
                "href": "s3://sentinel-s2-l2a/tiles/46/Q/DM/2024/10/15/0/B04.jp2",
                "type": "image/jp2",
                "eo:bands": [
                  {
                    "name": "red",
                    "common_name": "red",
                    "center_wavelength": 0.665,
                    "full_width_half_max": 0.038
                  }
                ],
                "gsd": 10,
                "proj:shape": [10980, 10980],
                "proj:transform": [10, 0, 300000, 0, -10, 1800000]
              },
              "green": {
                "href": "s3://sentinel-s2-l2a/tiles/46/Q/DM/2024/10/15/0/B03.jp2",
                "type": "image/jp2",
                "eo:bands": [
                  {
                    "name": "green",
                    "common_name": "green",
                    "center_wavelength": 0.56,
                    "full_width_half_max": 0.045
                  }
                ],
                "gsd": 10
              },
              "nir": {
                "href": "s3://sentinel-s2-l2a/tiles/46/Q/DM/2024/10/15/0/B08.jp2",
                "type": "image/jp2",
                "eo:bands": [
                  {
                    "name": "nir",
                    "common_name": "nir",
                    "center_wavelength": 0.842,
                    "full_width_half_max": 0.145
                  }
                ],
                "gsd": 10
              }
            },
            "links": [
              {
                "rel": "self",
                "href": "https://earth-search.aws.element84.com/v1/collections/sentinel-2-l2a/items/S2B_46QDM_20241015_0_L2A"
              }
            ]
          }
        ]
      },
      "output": {
        "items_found": 8,
        "best_scene_selected": {
          "id": "S2B_46QDM_20241015_0_L2A",
          "datetime": "2024-10-15T04:12:31.024000Z",
          "cloud_cover": 12.5
        }
      }
    },
    "step_2_imagery_download": {
      "description": "Download and crop Sentinel-2 bands using stackstac",
      "function": "download_imagery",
      "input_parameters": {
        "item": {
          "type": "STAC Item",
          "description": "Best scene from step 1 (lowest cloud cover)"
        },
        "bbox": {
          "type": "array",
          "value": [95.15, 15.9, 95.35, 16.1]
        }
      },
      "api_call": {
        "library": "stackstac",
        "method": "stackstac.stack",
        "parameters": {
          "items": ["<STAC Item from step 1>"],
          "assets": ["red", "green", "nir"],
          "epsg": 4326,
          "resolution": 0.0001,
          "bounds_latlon": [95.15, 15.9, 95.35, 16.1],
          "chunksize": [1, 1, 512, 512]
        }
      },
      "response_structure": {
        "type": "xarray.DataArray",
        "dimensions": {
          "time": 1,
          "band": 3,
          "y": 2000,
          "x": 2000
        },
        "coordinates": {
          "time": ["2024-10-15T04:12:31.024000Z"],
          "band": ["red", "green", "nir"],
          "x": {
            "type": "float64",
            "range": [95.15, 95.35],
            "step": 0.0001,
            "units": "degrees_east"
          },
          "y": {
            "type": "float64",
            "range": [15.9, 16.1],
            "step": 0.0001,
            "units": "degrees_north"
          }
        },
        "data_shape": [1, 3, 2000, 2000],
        "data_type": "float32",
        "data_range": {
          "min": 0,
          "max": 10000,
          "description": "Surface reflectance values (scaled)"
        }
      },
      "output": {
        "data_shape": [1, 3, 2000, 2000],
        "spatial_resolution": "10 meters",
        "pixel_count": 4000000,
        "study_area_coverage": "20km × 20km",
        "bands_loaded": ["red", "green", "nir"]
      }
    },
    "step_3_vegetation_indices": {
      "description": "Calculate NDVI, NDWI, and SAVI indices",
      "function": "calculate_indices",
      "input_parameters": {
        "data": {
          "type": "xarray.DataArray",
          "shape": [1, 3, 2000, 2000]
        }
      },
      "calculations": {
        "ndvi": {
          "formula": "(NIR - Red) / (NIR + Red + 1e-8)",
          "description": "Normalized Difference Vegetation Index",
          "range": [-1.0, 1.0],
          "threshold_mangrove": "> 0.3 and < 0.9"
        },
        "ndwi": {
          "formula": "(Green - NIR) / (Green + NIR + 1e-8)",
          "description": "Normalized Difference Water Index",
          "range": [-1.0, 1.0],
          "threshold_mangrove": "> -0.3"
        },
        "savi": {
          "formula": "((NIR - Red) / (NIR + Red + 0.5)) * 1.5",
          "description": "Soil Adjusted Vegetation Index",
          "range": [-1.5, 1.5],
          "threshold_mangrove": "> 0.2"
        }
      },
      "output": {
        "ndvi": {
          "shape": [2000, 2000],
          "dtype": "float64",
          "min": -0.234,
          "max": 0.876,
          "mean": 0.412
        },
        "ndwi": {
          "shape": [2000, 2000],
          "dtype": "float64",
          "min": -0.487,
          "max": 0.623,
          "mean": 0.089
        },
        "savi": {
          "shape": [2000, 2000],
          "dtype": "float64",
          "min": -0.351,
          "max": 1.314,
          "mean": 0.618
        }
      }
    },
    "step_4_mangrove_detection": {
      "description": "Detect mangrove pixels using threshold classification",
      "function": "detect_mangroves",
      "input_parameters": {
        "indices": {
          "ndvi": "array[2000, 2000]",
          "ndwi": "array[2000, 2000]",
          "savi": "array[2000, 2000]"
        }
      },
      "classification_criteria": {
        "ndvi_min": 0.3,
        "ndvi_max": 0.9,
        "ndwi_min": -0.3,
        "savi_min": 0.2,
        "logic": "AND (all conditions must be met)"
      },
      "output": {
        "mask": {
          "shape": [2000, 2000],
          "dtype": "float64",
          "values": [0, 1],
          "description": "Binary mask (1=mangrove, 0=non-mangrove)"
        },
        "statistics": {
          "mangrove_pixels": 713100,
          "total_pixels": 4000000,
          "coverage_percent": 17.8,
          "mangrove_area_hectares": 713.1,
          "pixel_area_m2": 100
        }
      }
    },
    "step_5_biomass_estimation": {
      "description": "Estimate above-ground biomass using allometric equation",
      "function": "estimate_biomass",
      "input_parameters": {
        "ndvi": "array[2000, 2000]",
        "mask": "array[2000, 2000]"
      },
      "allometric_model": {
        "equation": "Biomass = 250.5 × NDVI - 75.2",
        "units": "Mg/ha (megagrams per hectare)",
        "source": "Myanmar field studies",
        "r_squared": 0.72,
        "validation": "Field measurements from mangrove plots"
      },
      "output": {
        "biomass": {
          "shape": [2000, 2000],
          "dtype": "float64",
          "units": "Mg/ha",
          "masked_pixels": 713100
        },
        "statistics": {
          "mean": 127.8,
          "median": 132.4,
          "min": 0.0,
          "max": 194.2,
          "std": 28.5,
          "units": "Mg/ha"
        }
      }
    },
    "step_6_carbon_calculation": {
      "description": "Calculate carbon stocks using IPCC guidelines",
      "function": "calculate_carbon",
      "input_parameters": {
        "biomass_masked": "array[2000, 2000] (with NaN for non-mangrove)"
      },
      "ipcc_parameters": {
        "carbon_fraction": 0.47,
        "description": "Fraction of biomass that is carbon (IPCC default)",
        "co2_to_c_ratio": 3.67,
        "description_2": "Molecular weight ratio CO2/C"
      },
      "calculations": {
        "total_biomass": {
          "formula": "sum(valid_biomass) × pixel_area_ha",
          "pixel_area_ha": 0.01,
          "result": 91118,
          "units": "Mg"
        },
        "carbon_stock": {
          "formula": "total_biomass × 0.47",
          "result": 42825,
          "units": "Mg C"
        },
        "co2_equivalent": {
          "formula": "carbon_stock × 3.67",
          "result": 157169,
          "units": "Mg CO2"
        }
      },
      "output": {
        "total_biomass": 91118,
        "carbon_stock": 42825,
        "co2_equivalent": 157169,
        "units": {
          "total_biomass": "Mg",
          "carbon_stock": "Mg C",
          "co2_equivalent": "Mg CO2"
        }
      }
    },
    "step_7_export_results": {
      "description": "Export results as CSV summaries",
      "function": "export_results",
      "outputs": {
        "mangrove_area_summary.csv": {
          "format": "CSV",
          "encoding": "UTF-8",
          "structure": [
            {
              "Metric": "Mangrove Area (ha)",
              "Value": "713.1"
            },
            {
              "Metric": "Mean Biomass (Mg/ha)",
              "Value": "127.8"
            },
            {
              "Metric": "Median Biomass (Mg/ha)",
              "Value": "132.4"
            },
            {
              "Metric": "Max Biomass (Mg/ha)",
              "Value": "194.2"
            },
            {
              "Metric": "Std Deviation (Mg/ha)",
              "Value": "28.5"
            }
          ]
        },
        "biomass_carbon_summary.csv": {
          "format": "CSV",
          "encoding": "UTF-8",
          "structure": [
            {
              "Metric": "Total Biomass (Mg)",
              "Value": "91,118"
            },
            {
              "Metric": "Carbon Stock (Mg C)",
              "Value": "42,825"
            },
            {
              "Metric": "CO2 Equivalent (Mg CO2)",
              "Value": "157,169"
            },
            {
              "Metric": "Analysis Date",
              "Value": "2024-10-22"
            },
            {
              "Metric": "Scene Date",
              "Value": "2024-10-15"
            },
            {
              "Metric": "Cloud Cover (%)",
              "Value": "12.5"
            },
            {
              "Metric": "Uncertainty",
              "Value": "±30%"
            }
          ]
        }
      }
    }
  },
  "metadata": {
    "workflow_type": "Earth Observation",
    "application_domain": "Coastal Ecology",
    "ogc_standards": ["STAC", "CWL"],
    "data_sources": {
      "stac_catalog": "https://earth-search.aws.element84.com/v1",
      "imagery": "Sentinel-2 L2A (Copernicus/ESA)",
      "hosting": "AWS Open Data Registry"
    },
    "scientific_basis": {
      "allometric_model": "Myanmar field validation study",
      "carbon_methodology": "IPCC Guidelines for National Greenhouse Gas Inventories",
      "uncertainty": "±30% (based on model R² = 0.72)"
    },
    "execution_environment": {
      "python_version": ">=3.9",
      "key_libraries": {
        "pystac_client": ">=0.7.0",
        "stackstac": ">=0.5.0",
        "xarray": ">=2023.1.0",
        "numpy": ">=1.24.0",
        "pandas": ">=2.0.0"
      }
    }
  }
}
